{% extends "base.html" %}
{% block title %}Lobby - Kalambury{% endblock %}

{% block content %}
<div class="container">
 <h2 class="mb-4 text-center">Lobby gier</h2>

 <div class="d-flex justify-content-center mb-3">
  <a href="{{ url_for('main.create_game') }}" class="btn btn-success">Utw贸rz now gr</a>
 </div>

 {% if games %}
  <div class="row row-cols-1 row-cols-md-2 g-4" id="games-list-container">
   {% for game in games %}
   <div class="col" id="game-card-{{ game.id }}">
    <div class="card h-100 shadow-sm">
     <div class="card-body">
      <h5 class="card-title">{{ game.name }}</h5>
				<div class="game" id="game-{{ game.id }}">
					<p>Gracze w grze: <span id="player-count-{{ game.id }}">{{ game.players|length }}</span> / {{ game.max_players }}</p>
				</div>
      <p class="card-text mb-1">Czas rundy: {{ game.round_time }} sekund</p>
      {% if game.is_private %}
      <p class="card-text text-muted"><i>Pok贸j prywatny</i></p>
      {% endif %}
     </div>
     <div class="card-footer text-center">
      <a href="{{ url_for('main.join_game', game_id=game.id) }}" class="btn btn-primary w-100">Docz</a>
			{% if game.creator == username %}
				<form method="POST" action="{{ url_for('main.delete_game', game_id=game.id) }}" style="display:inline;">
				 <button type="submit" class="btn btn-danger btn-sm">Usu</button>
				</form>
			{% endif %}
     </div>
    </div>
   </div>
   {% endfor %}
  </div>
   <p class="text-center text-muted mt-4" id="no-games-message" style="display: none;">Brak dostpnych gier. Utw贸rz now gr!</p>
 {% else %}
      <p class="text-center text-muted" id="no-games-message">Brak dostpnych gier. Utw贸rz now gr!</p>
 {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();
    const gamesContainer = document.getElementById('games-list-container');
    const noGamesMessage = document.getElementById('no-games-message');

    // =================================================================
    //  1. OBSUGA USUWANIA POKOJU W CZASIE RZECZYWISTYM ('game_deleted')
    // =================================================================
    socket.on('game_deleted', (data) => {
        const gameId = data.game_id;
        const gameElement = document.getElementById(`game-card-${gameId}`);
        
        if (gameElement) {
            // gameElement jest ju偶 elementem <div class="col">, wic go po prostu usuwamy
            gameElement.remove();
            
            // Logika sprawdzajca, czy to bya ostatnia gra
            if (gamesContainer && gamesContainer.children.length === 0) {
                 // Sprawd藕, czy gamesContainer jest widoczny (by w DOM) i go ukryj
                 gamesContainer.style.display = 'none'; 
                 
                 if (noGamesMessage) {
                    noGamesMessage.style.display = 'block'; // Poka偶 wiadomo
                 }
            }
        }
    });

    // =================================================================
    //  2. OBSUGA AKTUALIZACJI LICZBY GRACZY ('update_player_count')
    // =================================================================
    socket.on('update_player_count', function(data) {
        const el = document.getElementById(`player-count-${data.game_id}`);
        if(el) el.innerText = data.count;
    });

    // Ujednolicenie eventu 'player_count_update' z 'update_player_count'
    // Jeli u偶ywasz obu, zostawiasz ten kt贸ry serwer wysya.
    // Zostawi na razie jeden, poniewa偶 Tw贸j kod u偶ywa 'update_player_count'.
    // Jeli serwer wysya 'player_count_update', zmie nazw eventu powy偶ej.
</script>
{% endblock %}